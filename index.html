<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fluxo v9 Ultra Prime â€” Make Your Edits Flowww âœ¦ Abhiii</title>

  <!-- html2canvas for export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* --- MacOS Pro style theme (clean, glassy) --- */
    :root{
      --bg-1:#eef2ff; /* will be overridden by theme class */
      --bg-2:#e6eef8;
      --card: rgba(255,255,255,0.06);
      --glass: rgba(255,255,255,0.06);
      --accent: #ff7ab6;
      --accent2: #ffb3d9;
      --muted: #7b8794;
      --glass-border: rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(10,12,20,0.25);
      --radius: 14px;
      --text: #041025;
      --watermark: 'Fluxo âœ¦ Abhiii';
    }
    /* theme variants */
    .theme-mac { --bg-1:#f7f5fb; --bg-2:#eef2ff; --accent:#c084fc; --accent2:#60a5fa; --text:#08102a; --card: rgba(255,255,255,0.9); --muted:#5a6a7a; --glass-border: rgba(12,18,28,0.06); --shadow: 0 12px 40px rgba(12,18,28,0.08); }
    .theme-dark { --bg-1:#071224; --bg-2:#0b2233; --accent:#60a5fa; --accent2:#a78bfa; --text:#e8f5ff; --card: rgba(255,255,255,0.03); --muted:#94a3b8; --glass-border: rgba(255,255,255,0.03); --shadow: 0 12px 40px rgba(2,6,12,0.6); }
    .theme-pink { --bg-1:#120417; --bg-2:#2b0a22; --accent:#ff7ab6; --accent2:#ffb3d9; --text:#feeaf4; --card: rgba(255,255,255,0.03); --muted:#f3c3d7; --shadow: 0 12px 40px rgba(20,6,20,0.6); }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;color:var(--text);background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}

    /* canvas background */
    canvas#bgCanvas{position:fixed;inset:0;z-index:0;display:block;pointer-events:none}

    /* layout */
    .wrap{position:relative;z-index:2;min-height:100vh;display:flex;flex-direction:column}
    header.hero{display:flex;align-items:center;justify-content:space-between;padding:26px 6vw 12px;gap:18px}
    .brand {font-family: "Playfair Display",serif; font-size:28px; background:linear-gradient(90deg,var(--accent),var(--accent2)); -webkit-background-clip:text; color:transparent; letter-spacing:0.4px}
    .tag {color:var(--muted); font-size:13px}

    .controls-top{display:flex;gap:12px;align-items:center}

    .theme-dot{width:28px;height:28px;border-radius:8px;cursor:pointer;border:1px solid var(--glass-border);box-shadow:0 6px 18px rgba(0,0,0,0.06)}

    main.main {max-width:1200px;margin:20px auto;width:94%;display:grid;grid-template-columns:1fr 420px;gap:22px;align-items:start;padding-bottom:40px}
    .card{background:var(--card);backdrop-filter: blur(8px);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid var(--glass-border)}
    .landing .lead{font-size:18px;color:var(--text);margin-bottom:6px}
    .landing .sublead{color:var(--muted);font-size:13px;margin:0}

    /* Brat */
    .brat-panel{margin-top:14px}
    .brat-opening{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:12px;cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px solid var(--glass-border)}
    .brat-opening:hover{transform:translateY(-4px);transition:all .22s}
    .brat-animated{height:74px;border-radius:10px;margin-top:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px}

    .brat-editor{display:grid;grid-template-columns:1fr 380px;gap:12px;margin-top:12px}
    .preview{height:360px;border-radius:12px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;border:1px solid var(--glass-border);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
    #bratCanvas{width:100%;height:100%;display:block}

    .brat-controls{display:flex;flex-direction:column;gap:10px}
    .label{font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], select {width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--glass-border);background:transparent;color:var(--text);outline:none}
    .swatches{display:flex;gap:8px;flex-wrap:wrap}
    .swatch{width:36px;height:36px;border-radius:8px;cursor:pointer;border:1px solid var(--glass-border)}
    .small-btn{padding:8px 10px;border-radius:8px;background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#041025;font-weight:700;cursor:pointer}
    .ghost{background:transparent;border:1px solid var(--glass-border);padding:10px 12px;border-radius:10px;color:var(--text)}

    /* studio right column */
    .studio .canvas-wrap{height:360px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.00));border:1px solid var(--glass-border)}
    .upload-btn{display:inline-flex;gap:8px;padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#041025;font-weight:700;cursor:pointer}

    .layers{margin-top:12px;display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto}
    .layer{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid var(--glass-border)}

    footer.sitefoot{text-align:center;padding:22px 10px;color:var(--muted);border-top:1px solid var(--glass-border);margin-top:18px;font-size:14px}

    /* top-center glowing logo */
    .fluxo-logo {
      position:fixed; left:50%; transform:translateX(-50%); top:14px; z-index:3500;
      background:linear-gradient(90deg,var(--accent),var(--accent2)); padding:8px 18px; border-radius:40px;
      color:white; font-weight:700; font-family:Playfair Display; box-shadow:0 8px 30px rgba(0,0,0,0.12); letter-spacing:0.6px;
      display:flex;align-items:center;gap:10px;backdrop-filter: blur(6px);
    }
    .fluxo-logo .glow{width:10px;height:10px;border-radius:50%;box-shadow:0 0 16px rgba(255,255,255,0.9); background:rgba(255,255,255,0.3)}

    /* toast */
    .toast{position:fixed;right:18px;top:80px;padding:10px 14px;border-radius:10px;background:rgba(0,0,0,0.7);color:white;z-index:4000;opacity:0;transform:translateY(-6px);transition:all .28s}

    /* hide UI during export */
    .hide-ui .controls-top, .hide-ui header, .hide-ui .sitefoot, .hide-ui .theme-dot, .hide-ui .ghost, .hide-ui .small-btn, .hide-ui .brat-controls, .hide-ui .brat-opening { display:none !important }
    .hide-ui .wrap{padding-top:40px}

    /* responsive */
    @media(max-width:1000px){
      main.main{grid-template-columns:1fr; padding:12px}
      .brat-editor{grid-template-columns:1fr}
      .studio{position:relative}
      .fluxo-logo{position:static;transform:none;margin:12px auto 0}
    }
  </style>
</head>
<body class="theme-mac">

  <!-- Top glowing logo -->
  <div class="fluxo-logo" title="Fluxo v9 Ultra Prime">
    <div class="glow" style="background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
    Fluxo âœ¦
  </div>

  <!-- subtle canvas background (soft glass) -->
  <canvas id="bgCanvas"></canvas>

  <div class="wrap">
    <header class="hero">
      <div>
        <div class="brand">Fluxo <span style="font-size:12px;font-weight:400;color:var(--muted);margin-left:8px">âœ¦ make your edits flowww</span></div>
        <div class="tag muted">Crafted with ðŸ’– by Abhiii â€” for the meme geeks</div>
      </div>

      <div class="controls-top">
        <div class="theme-select" style="display:flex;gap:8px;align-items:center">
          <div class="muted" style="font-size:13px;margin-right:8px">Themes</div>
          <div class="theme-dot" title="Mac" style="background:linear-gradient(90deg,#c084fc,#60a5fa)" data-theme="theme-mac"></div>
          <div class="theme-dot" title="Dark" style="background:linear-gradient(90deg,#60a5fa,#a78bfa)" data-theme="theme-dark"></div>
          <div class="theme-dot" title="Pink" style="background:linear-gradient(90deg,#ff7ab6,#ffb3d9)" data-theme="theme-pink"></div>
        </div>

        <button class="ghost" id="open-brat">Open Brat Lab</button>
        <button class="small-btn" id="goto-studio">Open Edit Studio</button>
      </div>
    </header>

    <main class="main">
      <!-- left: landing + brat -->
      <div>
        <div class="card landing">
          <div class="lead">Fluxo â€” Brat Lab & Meme Studio (Pro UI)</div>
          <div class="sublead">Create trendy brat text art with presets, glow, multi-layers, and HD export. No backend required.</div>
        </div>

        <div class="card brat-panel" id="brat-panel">
          <div class="brat-opening" id="brat-opening">
            <div>
              <div style="font-weight:700">Brat Generator Lab</div>
              <div class="muted" style="font-size:13px">Animated text art â€” fonts, colors, glow & clean export</div>
            </div>
            <div class="muted tiny">Click to expand</div>
          </div>

          <div class="brat-animated" id="brat-animated">Studio presets: Soft Pink â€¢ Lavender Dream â€¢ Golden Diva â€¢ Neon Rebel â€¢ Classic Mono</div>

          <div id="brat-editor" style="display:none; margin-top:12px;">
            <div class="brat-editor">
              <!-- preview -->
              <div>
                <div class="label">Live Preview</div>
                <div class="preview" id="preview">
                  <canvas id="bratCanvas" width="1200" height="600"></canvas>
                  <!-- watermark -->
                  <div id="watermark" style="position:absolute;right:18px;bottom:14px;color:rgba(255,255,255,0.35);font-weight:600;font-family:Inter;font-size:14px">Fluxo âœ¦ Abhiii</div>
                </div>

                <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
                  <button class="small-btn" id="brat-random">Random</button>
                  <button class="small-btn" id="generateBtn">Generate (Export)</button>
                  <div style="margin-left:auto;font-size:12px;color:var(--muted)">2 free generates/day â€¢ password unlock available</div>
                </div>
              </div>

              <!-- controls -->
              <div class="brat-controls">
                <div>
                  <div class="label">Add / Layers (max 3)</div>
                  <div style="display:flex;gap:8px">
                    <button class="ghost" id="addLayerBtn">+ Add Text</button>
                    <button class="ghost" id="removeLayerBtn">- Remove</button>
                    <button class="ghost" id="savePresetBtn">Save Preset</button>
                  </div>
                </div>

                <div id="layersControls" style="display:flex;flex-direction:column;gap:10px"></div>

                <div>
                  <div class="label">Background Presets</div>
                  <div class="swatches" id="bgSwatches">
                    <div class="swatch" style="background:linear-gradient(90deg,#fff3f8,#ffe6f0)" data-bg="linear-gradient(90deg,#fff3f8,#ffe6f0)"></div>
                    <div class="swatch" style="background:linear-gradient(90deg,#e6f0ff,#eff6ff)" data-bg="linear-gradient(90deg,#e6f0ff,#eff6ff)"></div>
                    <div class="swatch" style="background:linear-gradient(90deg,#f1f5f9,#e2e8f0)" data-bg="linear-gradient(90deg,#f1f5f9,#e2e8f0)"></div>
                    <div class="swatch" style="background:linear-gradient(90deg,#161616,#0b0b0b)" data-bg="linear-gradient(90deg,#161616,#0b0b0b)"></div>
                  </div>
                </div>

                <div>
                  <div class="label">Export Size</div>
                  <select id="exportSize">
                    <option value="1200x600">HD (1200Ã—600)</option>
                    <option value="1080x1080">Insta (1080Ã—1080)</option>
                    <option value="720x1280">Reel (720Ã—1280)</option>
                  </select>
                </div>

                <div style="margin-top:auto">
                  <div class="label">Generate Limit</div>
                  <div style="display:flex;gap:8px;align-items:center">
                    <div id="genInfo" class="muted">Free left: <strong id="freeLeft">2</strong></div>
                    <button class="ghost" id="unlockBtn" style="margin-left:auto">Enter password</button>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">Fluxo Labs</div>
              <div class="muted tiny">Pro features, local export, offline-first</div>
            </div>
            <div class="muted tiny">Version v9.0</div>
          </div>
        </div>
      </div>

      <!-- right: studio -->
      <aside class="card studio">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Quick Studio</div>
          <div class="muted tiny">Local edits â€¢ no backend</div>
        </div>

        <div style="height:12px"></div>

        <div class="canvas-wrap" id="studioCanvasWrap">
          <div id="studioArea" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center">
            <canvas id="studioCanvas" width="800" height="360" style="max-width:100%;border-radius:12px;background:transparent"></canvas>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <label class="upload-btn" for="fileInput">Upload Image</label>
          <input type="file" id="fileInput" accept="image/*" />
          <div style="display:flex;gap:8px">
            <button class="ghost" id="addTextStudio">Add Text</button>
            <button class="ghost" id="exportStudio">Export</button>
          </div>
        </div>

        <div class="layers" id="studioLayers"></div>

        <div style="margin-top:12px">
          <div class="label">Quick Filters</div>
          <div class="filter-row" style="display:flex;gap:8px;flex-wrap:wrap">
            <label class="tiny muted">Brightness <input id="fBrightness" type="range" min="60" max="140" value="100"></label>
            <label class="tiny muted">Contrast <input id="fContrast" type="range" min="60" max="140" value="100"></label>
            <label class="tiny muted">Saturation <input id="fSaturate" type="range" min="0" max="200" value="100"></label>
          </div>
        </div>

      </aside>
    </main>

    <footer class="sitefoot">crafted with ðŸ’– by Abhiii for the meme geeks</footer>
  </div>

  <!-- toast -->
  <div id="toast" class="toast"></div>

  <script>
  /* =========================
     Fluxo v9 â€” Brat Lab logic
     ========================= */

  // canvas & rendering
  const bratCanvas = document.getElementById('bratCanvas');
  const bctx = bratCanvas.getContext('2d');
  const preview = document.getElementById('preview');
  const watermark = document.getElementById('watermark');

  // controls
  const openBratBtn = document.getElementById('open-brat');
  const bratEditor = document.getElementById('brat-editor');
  const bratOpening = document.getElementById('brat-opening');
  const bratAnimated = document.getElementById('brat-animated');
  const addLayerBtn = document.getElementById('addLayerBtn');
  const removeLayerBtn = document.getElementById('removeLayerBtn');
  const layersControls = document.getElementById('layersControls');
  const bratRandom = document.getElementById('brat-random');
  const generateBtn = document.getElementById('generateBtn');
  const bgSwatches = document.getElementById('bgSwatches');
  const exportSize = document.getElementById('exportSize');
  const freeLeftEl = document.getElementById('freeLeft');
  const unlockBtn = document.getElementById('unlockBtn');
  const genInfo = document.getElementById('genInfo');
  const themeDots = document.querySelectorAll('.theme-dot');
  const toastEl = document.getElementById('toast');

  // app state
  let layers = []; // each layer: {id, text, font, size, color, x, y, align, glow, outline, shadow, visible}
  let bgStyle = 'linear-gradient(90deg,#fff3f8,#ffe6f0)'; // initial
  let exportLimit = { freePerDay: 2, usedToday: 0, unlockedUntil: 0 }; // unlockedUntil = timestamp
  let undoStack = [], redoStack = [];

  // initialize from localStorage
  const saved = localStorage.getItem('fluxo_state_v9');
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      if (parsed.exportLimit) exportLimit = parsed.exportLimit;
      if (parsed.layers) layers = parsed.layers;
      if (parsed.bgStyle) bgStyle = parsed.bgStyle;
    } catch(e){}
  }

  // helpers
  function toast(msg, t=3000) {
    toastEl.textContent = msg;
    toastEl.style.opacity = '1';
    toastEl.style.transform = 'translateY(0)';
    setTimeout(()=> {
      toastEl.style.opacity = '0';
      toastEl.style.transform = 'translateY(-6px)';
    }, t);
  }

  // save state
  function saveState() {
    localStorage.setItem('fluxo_state_v9', JSON.stringify({ layers, bgStyle, exportLimit }));
  }

  // generate unique id
  function uid(){ return Math.random().toString(36).slice(2,9); }

  // add default layer
  function createLayer(overrides={}) {
    if (layers.length >= 3) return null;
    const id = uid();
    const layer = Object.assign({
      id,
      text: "itâ€™s giving main character vibes ðŸ’…",
      font: "56px 'Playfair Display', serif",
      size: 56,
      color: "#ffe6f0",
      x: bratCanvas.width/2,
      y: bratCanvas.height/2,
      align: 'center',
      glow: true,
      outline: false,
      shadow: true,
      visible: true
    }, overrides);
    layers.push(layer);
    pushUndo();
    saveState();
    renderLayersUI();
    renderCanvas();
    return layer;
  }

  // remove last layer
  function removeLayer() {
    if (!layers.length) return;
    layers.pop();
    pushUndo();
    saveState();
    renderLayersUI();
    renderCanvas();
  }

  // push undo
  function pushUndo() {
    undoStack.push(JSON.parse(JSON.stringify({layers, bgStyle, exportLimit})));
    if (undoStack.length > 30) undoStack.shift();
    redoStack = [];
  }
  function doUndo(){ if(!undoStack.length) return; redoStack.push(JSON.parse(JSON.stringify({layers, bgStyle, exportLimit}))); const prev = undoStack.pop(); layers = prev.layers; bgStyle = prev.bgStyle; exportLimit = prev.exportLimit; renderLayersUI(); renderCanvas(); saveState(); }
  function doRedo(){ if(!redoStack.length) return; undoStack.push(JSON.parse(JSON.stringify({layers, bgStyle, exportLimit}))); const next = redoStack.pop(); layers = next.layers; bgStyle = next.bgStyle; exportLimit = next.exportLimit; renderLayersUI(); renderCanvas(); saveState(); }

  // render layer controls UI
  function renderLayersUI() {
    layersControls.innerHTML = '';
    layers.forEach((L, idx) => {
      const cont = document.createElement('div');
      cont.className = 'layer';
      cont.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:700">${idx+1}. ${L.text.substring(0,36)}</div>
          <div class="muted tiny">font: ${L.font.split(' ')[1] || 'â€”'} â€¢ size: ${L.size}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="ghost" data-act="edit" data-id="${L.id}">Edit</button>
          <button class="ghost" data-act="toggle" data-id="${L.id}">${L.visible? 'Hide':'Show'}</button>
        </div>
      `;
      layersControls.appendChild(cont);
    });

    // attach events
    layersControls.querySelectorAll('button[data-act]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const act = btn.dataset.act, id = btn.dataset.id;
        const idx = layers.findIndex(x=>x.id===id);
        if (act === 'edit') openLayerEditor(idx);
        if (act === 'toggle') { layers[idx].visible = !layers[idx].visible; pushUndo(); renderLayersUI(); renderCanvas(); saveState(); }
      });
    });
  }

  // open editor modal (simple prompt-based editor to keep single-file)
  function openLayerEditor(idx){
    const L = layers[idx];
    if(!L) return;
    const newText = prompt('Edit text', L.text);
    if(newText === null) return;
    L.text = newText;
    const newSize = prompt('Font size (px)', L.size) || L.size;
    L.size = Number(newSize);
    const newColor = prompt('Text color (hex)', L.color) || L.color;
    L.color = newColor;
    const newAlign = prompt('Align (left/center/right)', L.align) || L.align;
    L.align = newAlign;
    // position prompt (simple)
    const newX = prompt('X position (0..canvas width) - keep empty for no change', Math.round(L.x));
    if(newX) L.x = Number(newX);
    const newY = prompt('Y position (0..canvas height) - keep empty for no change', Math.round(L.y));
    if(newY) L.y = Number(newY);
    pushUndo(); renderLayersUI(); renderCanvas(); saveState();
  }

  // draw background
  function drawBackground(ctx) {
    // bgStyle stores CSS gradient string; draw a blurred gradient rectangle
    // create an offscreen canvas to render CSS-like gradient approximation
    const w = bratCanvas.width, h = bratCanvas.height;
    // simple linear gradient top-left -> bottom-right
    const g = ctx.createLinearGradient(0,0,w,h);
    // try to extract two colors from bgStyle or fallback
    if (bgStyle.includes('#')) {
      const matches = bgStyle.match(/#([0-9a-fA-F]{3,6})/g);
      const c1 = matches ? matches[0] : '#fff3f8';
      const c2 = matches && matches[1] ? matches[1] : '#ffe6f0';
      g.addColorStop(0, c1);
      g.addColorStop(1, c2);
    } else {
      g.addColorStop(0,'#fff3f8'); g.addColorStop(1,'#ffe6f0');
    }
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);
    // subtle vignette
    const vg = ctx.createRadialGradient(w/2,h/2,Math.min(w,h)/4,w/2,h/2,Math.max(w,h));
    vg.addColorStop(0,'rgba(255,255,255,0.0)');
    vg.addColorStop(1,'rgba(0,0,0,0.06)');
    ctx.fillStyle = vg;
    ctx.fillRect(0,0,w,h);
  }

  // render all layers to canvas
  function renderCanvas() {
    // clear
    bctx.clearRect(0,0,bratCanvas.width, bratCanvas.height);
    // background
    drawBackground(bctx);

    // render layers in order
    layers.forEach(L => {
      if(!L.visible) return;
      const fontFamily = L.font.includes('Playfair') ? "Playfair Display" : "Inter";
      bctx.font = `${L.size}px ${fontFamily}`;
      bctx.textBaseline = 'middle';
      bctx.textAlign = L.align;
      // shadow
      if (L.shadow) {
        bctx.shadowColor = 'rgba(0,0,0,0.25)';
        bctx.shadowBlur = 14;
        bctx.shadowOffsetY = 6;
      } else {
        bctx.shadowColor = 'transparent';
        bctx.shadowBlur = 0;
      }
      // outline
      if (L.outline) {
        bctx.lineWidth = Math.max(2, Math.round(L.size/18));
        bctx.strokeStyle = '#111';
        bctx.strokeText(L.text, L.x, L.y);
      }
      // glow (soft)
      if (L.glow) {
        bctx.save();
        bctx.globalCompositeOperation = 'lighter';
        bctx.fillStyle = L.color;
        for(let g=0; g<3; g++){
          bctx.shadowColor = L.color;
          bctx.shadowBlur = 10 + g*8;
          bctx.fillText(L.text, L.x, L.y);
        }
        bctx.restore();
      }
      // main fill
      bctx.fillStyle = L.color;
      bctx.fillText(L.text, L.x, L.y);
    });

    // watermark
    bctx.save();
    bctx.font = '14px Inter';
    bctx.fillStyle = 'rgba(255,255,255,0.18)';
    const wm = "Fluxo âœ¦ Abhiii";
    bctx.textAlign = 'right';
    bctx.fillText(wm, bratCanvas.width - 18, bratCanvas.height - 16);
    bctx.restore();
  }

  // responsive canvas sizing
  function setCanvasSizeFromExport(sizeStr){
    const [w,h] = sizeStr.split('x').map(s=>Number(s));
    bratCanvas.width = w;
    bratCanvas.height = h;
    // adjust layer positions proportionally if coming from different base
    renderCanvas();
  }

  // UI render for free generates left
  function refreshGenerateInfo() {
    // reset usedToday if date changed
    const dayKey = 'fluxo_gen_day_v9';
    const lastDay = localStorage.getItem(dayKey);
    const today = new Date().toDateString();
    if (lastDay !== today) {
      localStorage.setItem(dayKey, today);
      exportLimit.usedToday = 0;
    }
    const freeLeft = Math.max(0, exportLimit.freePerDay - (exportLimit.usedToday || 0));
    freeLeftEl.textContent = freeLeft;
    saveState();
  }

  // generate/export handler
  async function doGenerate(){
    const now = Date.now();
    if (exportLimit.unlockedUntil && now < exportLimit.unlockedUntil) {
      // unlocked - unlimited
    } else {
      // check free left
      refreshGenerateInfo();
      if ((exportLimit.usedToday || 0) >= exportLimit.freePerDay) {
        // blocked - ask password
        const pw = prompt('Free limit reached. Enter password to unlock (or Cancel).');
        if (!pw) return;
        if (pw.trim() !== 'ABHIJEET0123') { alert('Wrong password.'); return; }
        // unlock for 24h
        exportLimit.unlockedUntil = Date.now() + (24*60*60*1000);
        toast('Fluxo Ultra Mode âœ¦ Active (24h)');
        saveState();
      } else {
        // consume a free generate
        exportLimit.usedToday = (exportLimit.usedToday || 0) + 1;
        saveState();
      }
    }

    // hide UI for clean export
    document.body.classList.add('hide-ui');
    await sleep(120); // allow CSS to hide

    // set export size based on selection
    const size = exportSize.value || '1200x600';
    const [w,h] = size.split('x').map(n=>Number(n));
    // scale canvas to required size temporarily for crisp export
    const tmpCanvas = document.createElement('canvas');
    tmpCanvas.width = w; tmpCanvas.height = h;
    const tmpCtx = tmpCanvas.getContext('2d');

    // draw background using drawBackground but to tmpCtx
    drawExportBackground(tmpCtx, w, h);

    // draw layers scaled to new size
    layers.forEach(L => {
      if (!L.visible) return;
      const scaleX = w / bratCanvas.width;
      const scaleY = h / bratCanvas.height;
      const X = L.x * scaleX;
      const Y = L.y * scaleY;
      const SZ = Math.round(L.size * Math.min(scaleX, scaleY));
      const fontFamily = L.font.includes('Playfair') ? "Playfair Display" : "Inter";
      tmpCtx.font = `${SZ}px ${fontFamily}`;
      tmpCtx.textBaseline = 'middle';
      tmpCtx.textAlign = L.align;

      // shadow
      if (L.shadow) {
        tmpCtx.shadowColor = 'rgba(0,0,0,0.25)';
        tmpCtx.shadowBlur = 14 * Math.min(scaleX, scaleY);
        tmpCtx.shadowOffsetY = 6 * Math.min(scaleX, scaleY);
      } else {
        tmpCtx.shadowColor = 'transparent';
        tmpCtx.shadowBlur = 0;
      }
      // outline
      if (L.outline) {
        tmpCtx.lineWidth = Math.max(2, Math.round(SZ/18));
        tmpCtx.strokeStyle = '#111';
        tmpCtx.strokeText(L.text, X, Y);
      }
      // glow
      if (L.glow) {
        tmpCtx.save();
        tmpCtx.globalCompositeOperation = 'lighter';
        tmpCtx.fillStyle = L.color;
        for(let g=0; g<3; g++){
          tmpCtx.shadowColor = L.color;
          tmpCtx.shadowBlur = 10 + g*8;
          tmpCtx.fillText(L.text, X, Y);
        }
        tmpCtx.restore();
      }
      // main fill
      tmpCtx.fillStyle = L.color;
      tmpCtx.fillText(L.text, X, Y);
    });

    // watermark
    tmpCtx.save();
    tmpCtx.font = '18px Inter';
    tmpCtx.fillStyle = 'rgba(0,0,0,0.08)';
    tmpCtx.textAlign = 'right';
    tmpCtx.fillText('Fluxo âœ¦ Abhiii', w - 18, h - 18);
    tmpCtx.restore();

    // convert to blob and download
    tmpCanvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fluxo_${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      // restore UI
      setTimeout(()=> document.body.classList.remove('hide-ui'), 400);
      toast('Export complete â€” saved to your device');
    }, 'image/png');

    saveState();
  }

  function drawExportBackground(ctx, w, h) {
    // draw gradient using bgStyle
    const g = ctx.createLinearGradient(0,0,w,h);
    const matches = bgStyle.match(/#([0-9a-fA-F]{3,6})/g);
    const c1 = matches ? matches[0] : '#fff3f8';
    const c2 = matches && matches[1] ? matches[1] : '#ffe6f0';
    g.addColorStop(0, c1);
    g.addColorStop(1, c2);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);
    // subtle vignette
    const vg = ctx.createRadialGradient(w/2,h/2,Math.min(w,h)/4,w/2,h/2,Math.max(w,h));
    vg.addColorStop(0,'rgba(255,255,255,0.0)');
    vg.addColorStop(1,'rgba(0,0,0,0.06)');
    ctx.fillStyle = vg; ctx.fillRect(0,0,w,h);
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  // randomizer
  function randomize() {
    const presets = [
      {text:"itâ€™s giving main character vibes ðŸ’…", font:"56px 'Playfair Display'", color:"#ffe6f0"},
      {text:"mood: unapologetically extra âœ¨", font:"54px 'Montserrat'", color:"#e6f0ff"},
      {text:"queen energy served ðŸ‘‘", font:"58px 'Playfair Display'", color:"#fff3e0"},
      {text:"lowkey iconic", font:"52px 'Courier New'", color:"#eafaf1"}
    ];
    layers = [];
    const pcount = Math.min(3, Math.max(1, Math.floor(Math.random()*3)+1));
    for(let i=0;i<pcount;i++){
      const p = presets[Math.floor(Math.random()*presets.length)];
      createLayer({
        text: p.text,
        font: p.font,
        size: parseInt(p.font,10),
        color: p.color,
        x: bratCanvas.width/2,
        y: bratCanvas.height/2 + (i-1)*80,
        align: 'center',
        glow: Math.random()>0.3,
        outline: Math.random()>0.6,
        shadow: true
      });
    }
    saveState();
    toast('Randomized â€” tweak as needed');
  }

  // bg swatch clicks
  bgSwatches.querySelectorAll('.swatch').forEach(s=>{
    s.addEventListener('click', ()=> {
      bgStyle = s.dataset.bg;
      pushUndo(); saveState(); renderCanvas();
    });
  });

  // theme dots
  themeDots.forEach(td => td.addEventListener('click', ()=> {
    const t = td.dataset.theme;
    document.body.className = t;
    toast('Theme applied');
  }));

  // add/remove layer events
  addLayerBtn.addEventListener('click', ()=> {
    if (layers.length >= 3) { toast('Max 3 layers'); return; }
    createLayer();
  });
  removeLayerBtn.addEventListener('click', ()=> {
    if (!layers.length) { toast('No layers to remove'); return; }
    removeLayer();
  });

  // open/close Brat Lab
  openBratBtn.addEventListener('click', ()=> {
    const shown = bratEditor.style.display === 'block';
    bratEditor.style.display = shown ? 'none' : 'block';
    if (!shown && !layers.length) createLayer();
  });
  bratOpening.addEventListener('click', ()=> openBratBtn.click());

  // random button
  bratRandom.addEventListener('click', () => randomize());

  // generate button
  generateBtn.addEventListener('click', () => doGenerate());

  // unlock password
  unlockBtn.addEventListener('click', ()=> {
    const pw = prompt('Enter password to unlock Fluxo Ultra Mode (24h):');
    if (!pw) return;
    if (pw.trim() === 'ABHIJEET0123') {
      exportLimit.unlockedUntil = Date.now() + (24*60*60*1000);
      toast('Fluxo Ultra Mode âœ¦ Active (24h)');
      saveState();
    } else {
      alert('Incorrect password.');
    }
  });

  // render initial UI
  function init() {
    // if no layers, create a default one
    if (!layers.length) createLayer();
    renderLayersUI();
    // ensure default canvas size fits current (base)
    setCanvasSizeFromExport('1200x600');
    renderCanvas();
    refreshGenerateInfo();
    // update freeLeft display from localStorage
    const dayKey = 'fluxo_gen_day_v9';
    const today = new Date().toDateString();
    if (!localStorage.getItem(dayKey)) localStorage.setItem(dayKey, today);
  }
  init();

  /* =========================
     Gentle background particles (subtle, not flashy)
     ========================= */
  (function bgParticles(){
    const c = document.getElementById('bgCanvas'), ctx = c.getContext('2d');
    let DPR = Math.max(1, window.devicePixelRatio || 1);
    function resize(){ DPR = Math.max(1, window.devicePixelRatio || 1); c.width = innerWidth * DPR; c.height = innerHeight * DPR; c.style.width = innerWidth + 'px'; c.style.height = innerHeight + 'px'; ctx.setTransform(DPR,0,0,DPR,0,0); }
    window.addEventListener('resize', resize); resize();
    const parts = [];
    const N = Math.max(20, Math.floor((innerWidth*innerHeight)/180000));
    for(let i=0;i<N;i++) parts.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:1+Math.random()*2,vx:(Math.random()-0.5)*0.2,vy:(Math.random()-0.5)*0.2,h:200+Math.random()*80});
    let mouse = {x:innerWidth/2,y:innerHeight/2};
    window.addEventListener('mousemove', e=>{mouse.x=e.clientX;mouse.y=e.clientY});
    function draw(){
      ctx.clearRect(0,0,innerWidth,innerHeight);
      const g = ctx.createLinearGradient(0,0,innerWidth,innerHeight);
      g.addColorStop(0, 'rgba(255,255,255,0.02)');
      g.addColorStop(1, 'rgba(0,0,0,0.02)');
      ctx.fillStyle = g; ctx.fillRect(0,0,innerWidth,innerHeight);
      for(let p of parts){
        p.x += p.vx + (mouse.x - p.x)*0.0002;
        p.y += p.vy + (mouse.y - p.y)*0.0002;
        if (p.x < -50) p.x = innerWidth + 50;
        if (p.x > innerWidth + 50) p.x = -50;
        if (p.y < -50) p.y = innerHeight + 50;
        if (p.y > innerHeight + 50) p.y = -50;
        const gr = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*8);
        gr.addColorStop(0, 'rgba(167,139,250,0.06)');
        gr.addColorStop(1, 'rgba(96,165,250,0.01)');
        ctx.fillStyle = gr;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      }
      requestAnimationFrame(draw);
    }
    draw();
  })();

  /* =========================
     Studio (right) â€” very basic local editor for quick uploads (kept simple)
     ========================= */
  (function studio(){
    const studioCanvas = document.getElementById('studioCanvas');
    const sctx = studioCanvas.getContext('2d');
    const fileInput = document.getElementById('fileInput');
    const studioLayers = document.getElementById('studioLayers');
    let sLayers = []; // image or text
    function renderStudio(){
      sctx.clearRect(0,0,studioCanvas.width,studioCanvas.height);
      // background subtle
      sctx.fillStyle = 'rgba(255,255,255,0.02)'; sctx.fillRect(0,0,studioCanvas.width,studioCanvas.height);
      sLayers.forEach(L=>{
        if(L.type==='image' && L.img){ sctx.drawImage(L.img,0,0,studioCanvas.width,studioCanvas.height); }
        if(L.type==='text'){
          sctx.font = `${L.size}px ${L.font}`; sctx.fillStyle = L.color; sctx.textAlign = L.align; sctx.fillText(L.text, L.x*studioCanvas.width, L.y*studioCanvas.height);
        }
      });
    }
    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const img = new Image();
      img.onload = ()=> { sLayers = [{type:'image', img}]; renderStudio(); toast('Image uploaded'); }
      img.src = URL.createObjectURL(f);
    });
    document.getElementById('addTextStudio').addEventListener('click', ()=>{
      const txt = prompt('Add text for studio');
      if(!txt) return;
      sLayers.push({type:'text',text:txt,size:40,font:'Inter',color:'#fff',x:0.5,y:0.5,align:'center'});
      renderStudio();
    });
    document.getElementById('exportStudio').addEventListener('click', ()=>{
      html2canvas(document.getElementById('studioArea')).then(canvas=> {
        canvas.toBlob(b=> { const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='fluxo_studio.png'; a.click(); URL.revokeObjectURL(a.href); toast('Studio export saved'); });
      });
    });
    renderStudio();
  })();

  /* keyboard shortcuts */
  window.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.key === 'z') { doUndo(); }
    if(e.ctrlKey && e.key === 'y') { doRedo(); }
  });

  </script>
</body>
</html>
